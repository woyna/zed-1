---
title: "Zaawansowana Eksploracja Danych - Projekt 1"
author: "Wojciech Przybylski"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r global_settings, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results='hide', message=FALSE, warning=FALSE, error=FALSE)
```

## Podsumowanie

---
todo
---

## Opis zbioru danych

```{r libs, include=FALSE}
library(dplyr)
library(xlsx)
library(ggplot2)
library(plotly)
library(kableExtra)
library(cowplot)
```

Dane zawierają informacje o wynikach badań krwi pacjentów chorych na COVID-19, przyjętych do szpitala Tongji w Wuhan (Chiny). Zebrane zostały między 10 stycznia a 18 lutego 2020 roku.

```{r load_data, include=FALSE, cache=TRUE}
blood_test <- read.xlsx('wuhan_blood_sample_data_Jan_Feb_2020.xlsx', 1, header=TRUE)
```

Wczytane dane zawierają `r nrow(blood_test)` wierszy opisanych przez `r ncol(blood_test)` atrybutów. Poniżej znajduje się krótki opis każdego atrybutu.

|Nazwa atrybutu|Komentarz|
|-|-|
|`r colnames(blood_test[1])`|identyfikator pacjenta|
|`r colnames(blood_test[2])`|data i czas zebrania pomiaru|
|`r colnames(blood_test[3])`|wiek pacjenta|
|`r colnames(blood_test[4])`|płeć pacjenta (1 - kobieta, 2 - mężczyzna)|
|`r colnames(blood_test[5])`|data i czas przyjęcia pacjenta|
|`r colnames(blood_test[6])`|data i czas wypisania pacjenta|
|`r colnames(blood_test[7])`|czy zmarł? (0 - nie, 1 - tak)|
|`r colnames(blood_test[8])`|stężenie troponiny sercowej [ng/l]|
|`r colnames(blood_test[9])`|stężenie hemoglobiny [g/l]|
|`r colnames(blood_test[10])`|stężenie chlorków [mmol/l]|
|`r colnames(blood_test[11])`|czas protrombinowy [s]|
|`r colnames(blood_test[12])`|stężenie prokalcytoniny  [ng/ml]|
|`r colnames(blood_test[13])`|zawartość eozynofili [%]|
|`r colnames(blood_test[14])`|stężenie interleukiny-2 [pg/ml]|
|`r colnames(blood_test[15])`|stężenie fosfatazy alkalicznej [U/l]|
|`r colnames(blood_test[16])`|stężenie albuminy [g/l]|
|`r colnames(blood_test[17])`|zawartość bazofili [%]|
|`r colnames(blood_test[18])`|stężenie interleukiny-10 [pg/ml]|
|`r colnames(blood_test[19])`|bilirubina całkowita [µmol/l]|
|`r colnames(blood_test[20])`|liczba płytek krwi [10<sup>3</sup>/µl]|
|`r colnames(blood_test[21])`|zawartość monocytów [%]|
|`r colnames(blood_test[22])`|aktywność antytrombiny [% normy]|
|`r colnames(blood_test[23])`|stężenie interleukiny-8 [pg/ml]|
|`r colnames(blood_test[24])`|bilirubina pośrednia [µmol/l]|
|`r colnames(blood_test[25])`|RDW-CV [%]|
|`r colnames(blood_test[26])`|zawartość neutrofili [%]|
|`r colnames(blood_test[27])`|stężenie białka całkowitego [g/l]|
|`r colnames(blood_test[28])`|przeciwciała kiły IgG/IgM|
|`r colnames(blood_test[29])`|aktywność protrombiny [% normy]|
|`r colnames(blood_test[30])`|HBsAg [s/c]|
|`r colnames(blood_test[31])`|średnia objętość krwinki czerwonej (MCV) [fl]|
|`r colnames(blood_test[32])`|hematokryt [%]|
|`r colnames(blood_test[33])`|liczba krwinek białych [10<sup>9</sup>/l]|
|`r colnames(blood_test[34])`|TNF alfa [pg/ml]|
|`r colnames(blood_test[35])`|średnie stężenie hemoglobiny w erytrocytach [g/l]|
|`r colnames(blood_test[36])`|fibrynogen [g/l]|
|`r colnames(blood_test[37])`|stężenie interleukiny-1β [pg/ml]|
|`r colnames(blood_test[38])`|stężenie mocznika [mmol/l]|
|`r colnames(blood_test[39])`|liczba limfocytów [10<sup>9</sup>/l]|
|`r colnames(blood_test[40])`|pH|
|`r colnames(blood_test[41])`|liczba krwinek czerwonych [10<sup>12</sup>/l]|
|`r colnames(blood_test[42])`|zawartość eozynofili|
|`r colnames(blood_test[43])`|skorygowane stężenie wapnia [mg/dl]|
|`r colnames(blood_test[44])`|stężenie potasu [mmol/l]|
|`r colnames(blood_test[45])`|stężenie glukozy [mmol/l]|
|`r colnames(blood_test[46])`|liczba neutrofili [10<sup>3</sup>/µl]|
|`r colnames(blood_test[47])`|bilirubina bezpośrednia [µmol/l]|
|`r colnames(blood_test[48])`|średnia objętość płytek krwi [fl]|
|`r colnames(blood_test[49])`|stężenie ferrytyny [μg/l]|
|`r colnames(blood_test[50])`|rozpiętość rozkładu objętości erytrocytów pacjenta [%]|
|`r colnames(blood_test[51])`|czas trombinowy [s]|
|`r colnames(blood_test[52])`|zawartość limfocytów [%]|
|`r colnames(blood_test[53])`|przeciwciała HCV [log IU/ml]|
|`r colnames(blood_test[54])`|stężenie D-dimerów [ng/ml]|
|`r colnames(blood_test[55])`|cholesterol całkowity [mmol/l]|
|`r colnames(blood_test[56])`|poziom aminotransferazy asparaginianowej (U/l)|
|`r colnames(blood_test[57])`|stężenie kwasu moczowego [µmol/l]|
|`r colnames(blood_test[58])`|stężenie wodorowęglanów w osoczu [mmol/l]|
|`r colnames(blood_test[59])`|stężenie wapnia [mmol/l]|
|`r colnames(blood_test[60])`|stężenie NT-proBNP [pg/ml]|
|`r colnames(blood_test[61])`|stężenie LDH [U/l]|
|`r colnames(blood_test[62])`|P-LCR [%]|
|`r colnames(blood_test[63])`|stężenie interleukiny-6 [pg/ml]|
|`r colnames(blood_test[64])`|stężenie fibrynogenu [µg/ml]|
|`r colnames(blood_test[65])`|liczba monocytów [10<sup>3</sup>/µl]|
|`r colnames(blood_test[66])`|szerokość dystrybucji płytek krwi [%]|
|`r colnames(blood_test[67])`|stężenie globuliny [g/l]|
|`r colnames(blood_test[68])`|stężenie glutamylotransferazy [U/l]|
|`r colnames(blood_test[69])`|INR|
|`r colnames(blood_test[70])`|zawartość bazofili [%]|
|`r colnames(blood_test[71])`|wykrywanie kwasu nukleinowego 2019-nCoV|
|`r colnames(blood_test[72])`|średnia waga hemoglobiny w czerwonej krwince [pg]|
|`r colnames(blood_test[73])`|czas kaolinowo-kefalinowy [s]|
|`r colnames(blood_test[74])`|hs-CRP [mg/l]|
|`r colnames(blood_test[75])`|przeciwciała HIV|
|`r colnames(blood_test[76])`|stężenie sodu [mmol/l]|
|`r colnames(blood_test[77])`|trombokryt|
|`r colnames(blood_test[78])`|odczyn Biernackiego [mm/h]|
|`r colnames(blood_test[79])`|stężenie aminotransferazy alaninowej [U/l]|
|`r colnames(blood_test[80])`|eGFR [ml/min/1.73m<sup>2</sup>]|
|`r colnames(blood_test[81])`|stężenie kreatyniny [μmol/l]|

```{r clean_data, include=FALSE}
# fill patient IDs
counter <- 0
for(i in 1:nrow(blood_test)) {
    if (!is.na(blood_test[i,1])) {
        j = blood_test[i,1]
    }
    else {
        blood_test[i,1] = j
        counter = counter + 1
    }
}

# group by patient IDs
blood_test_grouped <- blood_test %>% group_by(PATIENT_ID)

# calculate mean of every numeric value
blood_test_grouped <- blood_test_grouped %>%  summarize(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

# replace NaN with NA
blood_test_grouped <- blood_test_grouped %>% replace(is.na(.), NA)

# change gender and outcome attribute to binominal
blood_test_grouped$gender <- as.factor(blood_test_grouped$gender)
blood_test_grouped$outcome <- as.factor(blood_test_grouped$outcome)
```

W procesie czyszczenia danych uzupełnione zostały brakujące wartości ID pacjentów. Uzupełniono w ten sposób `r counter` wierszy danych.

Następnie pogrupowano wiersze wg ID pacjenta, uzupełniając wartości atrybutów numerycznych ich średnią na przestrzeni całej grupy. W przypadku, kiedy w danej grupie atrybut miał zawsze pustą wartość, zastąpiono go wartością NA.

Ponadto, zmieniono typ kolumn gender i outcome z numerycznego na kategoryczny.

## Zależności między atrybutami

Poniżej zaprezentowano zaobserwowane zależności między wybranymi atrybutami.

### Wiek i płeć

```{r gender_summary}
gender_summary <- blood_test_grouped %>% mutate(gender = if_else(condition = gender == 1, 'kobieta', 'mężczyzna')) %>% mutate(survived = if_else(condition = outcome == 0, 'tak', 'nie')) %>% group_by(gender, survived) %>% count(name = 'liczebność') %>% arrange(desc(gender))
```

```{r gender_summary_table, results='markup'}
gender_summary %>% rename('płeć' = gender, 'przeżył' = survived) %>% kbl() %>% kable_classic_2(full_width = F) %>% row_spec(0, bold = T)
```

```{r gender_age_summary_plot, results='markup'}
gender_age_survived_summary <- blood_test_grouped %>% mutate(age_group = factor(1*(age > 35) + 1*(age > 55), labels = c('18-35', '36-55', '56+'))) %>% mutate(gender = if_else(condition = gender == 1, 'kobieta', 'mężczyzna')) %>% mutate(survived = if_else(condition = outcome == 0, 'tak', 'nie')) %>% group_by(gender, age_group, survived) %>% count(name = 'liczebność') %>% rename('płeć' = gender, 'przeżył' = survived)

gender_age_summary_plot <- ggplot(gender_age_survived_summary, aes(x = płeć, y = liczebność, fill = przeżył)) + geom_col(width = 0.4) + facet_grid(. ~ age_group) + theme_light()
ggplotly(gender_age_summary_plot)
```

Z powyższego wykresu można wywnioskować, że istotnymi przy określeniu szans na przeżycie atrybutami są płeć oraz wiek pacjenta.

### Neutrofile

Neutrofile stanowią jedną z grup leukocytów (białych krwinek). Są istotnym składnikiem układu odpornościowego człowieka, ponieważ odpowiadają za rozpoznanie wrogich patogenów i ich neutralizację. Podwyższenie poziomu neutrofili we krwi następuje w przypadku infekcji.

Normy zawartości oraz liczby neutrofili we krwi dla osoby dorosłej (źródło: [healthline.com](https://www.healthline.com/health/neutrophils)):

```{r neutrophils_normal_range_table, results='markup'}
percent_min = 45
percent_max = 75
count_min = 1
count_max = 8

neutro_normal_range <- data.frame('empty' = c('liczba neutrocytów [tys./µl]', 'zawartość białych krwinek [%]'), 'Min' = c(count_min, percent_min), 'Max' = c(count_max, percent_max))

neutro_normal_range %>% rename(' ' = empty) %>% kbl() %>% kable_classic_2(full_width = F) %>% row_spec(0, bold = T)
```

```{r neutrophils}
neutrophils <- blood_test_grouped %>% select(neutrophils..., neutrophils.count, outcome) %>% mutate(outcome = if_else(condition = outcome == 0, 'tak', 'nie')) %>% rename(survived = outcome) %>% mutate(survived = factor(survived)) %>% rename(przeżył = survived, liczba.neutrofili = neutrophils.count, procent.neutrofili = neutrophils...)
```

```{r neutrophils_plot, results='markup'}
neutrophils_plot <- ggplot(neutrophils, aes(x=liczba.neutrofili, y=procent.neutrofili, color=przeżył)) + geom_point() + geom_hline(yintercept=range(percent_min, percent_max), linetype='dashed') + geom_vline(xintercept=range(count_min, count_max), linetype='dashed') + labs(x = 'zawartość neutrofili [%]', y='liczba neutrofili [tys. komórek/µl]') + theme_light()
ggplotly(neutrophils_plot)
```

Na powyższym wykresie wyraźnie widać, że u pacjentów z podwyższonym poziomem neutrofili śmietelność jest wyższa.

### Dehydrogenaza mleczanowa (LDH)

Dehydrogenaza mleczanowa (inaczej LDH) to enzym odgrywający kluczową rolę w przemianie glukozy w energię. U osób zdrowych dehydrogenaza jest umiejscowiona w cytoplazmie, a do krwi wydzielana jest jedynie w momencie uszkodzenia komórki lub wzrostu przepuszczalności błony komórkowej, czyniąc LDH ważnym markerem niewydolności narządowej, wykorzystywanym w diagnostyce chorób wewnętrznych.

Normy stężenia dehydrogenazy mleczanowej we krwi dla osoby dorosłej (źródło: [University of Rochester Medical Center](https://www.urmc.rochester.edu/encyclopedia/content.aspx?contenttypeid=167&contentid=lactic_acid_dehydrogenase_blood)):

```{r ldh_normal_range_table, results='markup'}
ldh_min = 140
ldh_max = 280

ldh_normal_range <- data.frame('empty' = 'stężenie LDH [U/l]', 'Min' = ldh_min, 'Max' = ldh_max)

ldh_normal_range %>% rename(' ' = empty) %>% kbl() %>% kable_classic_2(full_width = F) %>% row_spec(0, bold = T)
```

```{r ldh}
ldh <- blood_test_grouped %>% select(Lactate.dehydrogenase, outcome, age) %>% mutate(outcome = if_else(condition = outcome == 0, 'tak', 'nie')) %>% rename(survived = outcome, LDH = Lactate.dehydrogenase) %>% mutate(survived = factor(survived)) %>% rename(przeżył = survived, wiek = age)
```

```{r ldh_plot, results='markup'}
ldh_plot <- ggplot(ldh, aes(x=wiek, y=LDH, color=przeżył)) + geom_point() + geom_hline(yintercept=range(ldh_min, ldh_max), linetype='dashed') + labs(y='LDH [U/l]') + theme_light()
ggplotly(ldh_plot)
```

Na powyższym wykresie wyraźnie widać, że u pacjentów z podwyższonym poziomem LDH śmietelność jest wyższa. 

## Zmiana atrytbutów w czasie

```{r attributes_time_change, cache=TRUE}
attributes_time_change = data.frame(patientId = numeric(), no = numeric(), outcome = numeric(), colName = character(), value = numeric())
noCount = -1
patientID = -1

for(i in 8:ncol(blood_test)) {
  for (j in 1:nrow(blood_test)) {
    if (is.na(blood_test[j,i]) | !is.numeric(blood_test[j,i])) {
      next
    }
    
    if (blood_test$PATIENT_ID[j] != patientID) {
      noCount = 1
    }
    else {
      noCount = noCount + 1  
    }
    
    newRow = data.frame(blood_test$PATIENT_ID[j], noCount, blood_test$outcome[j], colnames(blood_test)[i], blood_test[j,i]) 
    names(newRow) = colnames(attributes_time_change)
    attributes_time_change = rbind(attributes_time_change, newRow)
    patientID = blood_test$PATIENT_ID[j]
  }
}

attributes_time_change <- attributes_time_change %>% mutate(survived = if_else(condition = outcome == 0, 'tak', 'nie'), colName = factor(colName))
plots <- c()

for(i in seq_along(levels(attributes_time_change$colName))) {
  maxNo = (attributes_time_change %>% filter(colName %in% levels(colName)[i]) %>% group_by(survived) %>% summarize(maxNo = max(no, na.rm = TRUE)) %>% arrange(maxNo))[1,2]
  
  if (maxNo[1] < 6) {
    next
  }
  
  colPlot <- attributes_time_change %>% filter(colName %in% levels(colName)[i]) %>% filter(no <= (as.numeric(maxNo[1]) - 1)) %>% group_by(no, survived) %>% summarize(mean_val = mean(value), colName = first(colName))
  plot <- ggplot(colPlot, aes(x=no, y=mean_val, color=survived)) + geom_line() + labs(title = colPlot$colName)
  
  if (!is.null(plot)) {
    plots <- c(plots, list(plot))  
  }
}
```

W celu znalezienia atrybutów, których zmiana w czasie obrazuje pewien trend, wykonano następujące czynności:

1. Dla każdego pacjenta zebrane zostały informacje o liczbie pomiarów każdego atrybutu.
2. Wyliczono średnią każdego kolejnego pomiaru atrybutu i pogrupowano wyniki na pacjentów, którzy przeżyli i na pacjentów, którzy zmarli.
3. Atrybuty, które nie miały przynajmniej sześciu pomiarów, zostały odrzucone. Uznano je za zbyt mało liczne, żeby na podstawie wyników wnioskować o trendzie dla danego atrybutu.
4. Wygenerowano wykresy zmiany atrybutów w czasie z podziałem na pacjentów, którzy przeżyli i na pacjentów, którzy nie przeżyli, dla wszystkich atrybutów, które spełniły kryteria z poprzednich punktów.
5. Z wygenerowanych wykresów wybrano te, które obrazowały różnice między grupami pacjentów i na których widać pewien trend.

```{r meanPlots, fig.height=60, fig.width=15}
#plot_grid(plotlist = plots, ncol = 3)
```

### Fosfataza alkaliczna

Fosfataza alkaiczna (ALP) jest enzymem, który wraz z żółcią wydalany jest z wątroby do przewodu pokarmowego. Jeśli w organizmie występują problemy z wydzielaniem żółci, wówczas poziom fosfatazy we krwi wzrasta.

```{r phosphatasePlot, results='markup'}
maxNo = (attributes_time_change %>% filter(colName == 'Alkaline.phosphatase') %>% group_by(survived) %>% summarize(maxNo = max(no, na.rm = TRUE)) %>% arrange(maxNo))[1,2]
  
phosphatase <- attributes_time_change %>% filter(colName == 'Alkaline.phosphatase') %>% filter(no <= (as.numeric(maxNo[1]) - 1)) %>% group_by(no, survived) %>% summarize(mean_val = mean(value), colName = first(colName)) %>% rename(przeżył = survived)

phosphatasePlot <- ggplot(phosphatase, aes(x=no, y=mean_val, color=przeżył)) + geom_line() + labs(x='nr próbki', y='śr. stężenie fosfatazy alkalicznej [U/l]') + theme_light()

ggplotly(phosphatasePlot)
```

Wykres wykazuje średnio wyższe stężenie fosfatazy alkaicznej oraz trend rosnący dla osób, którym nie udało się przeżyć zakażenia wirusem.

### Bilirubina bezpośrednia

Bilirubina bezpośrednia (zwana też bilirubiną związaną lub sprzężoną) stanowi produkt degradacji części porfirynowej hemu (głównie hemoglobiny), który uwalniany jest ze zniszczonych krwinek czerwonych. Podwyższone wartości stężenia bilirubiny bezpośredniej we krwi powiązane są z problemami z wątrobą.

```{r directBilirubinPlot, results='markup'}
maxNo = (attributes_time_change %>% filter(colName == 'Direct.bilirubin') %>% group_by(survived) %>% summarize(maxNo = max(no, na.rm = TRUE)) %>% arrange(maxNo))[1,2]
  
directBilirubin <- attributes_time_change %>% filter(colName == 'Direct.bilirubin') %>% filter(no <= (as.numeric(maxNo[1]) - 1)) %>% group_by(no, survived) %>% summarize(mean_val = mean(value), colName = first(colName)) %>% rename(przeżył = survived)

directBilirubinPlot <- ggplot(directBilirubin, aes(x=no, y=mean_val, color=przeżył)) + geom_line() + labs(x='nr próbki', y='śr. stężenie bilirubiny bezpośredniej [µmol/l]') + theme_light()

ggplotly(directBilirubinPlot)
```

Wykres prezentuje stałe stężenie bilirubiny bezpośredniej u osób, którym udało się przeżyć zakażenie wirusem. Średnie stężenei bilirubiny bezpośredniej jest wyższe i ma tendencję rosnącą u osób, którym nie udało się przeżyć.

### eGFR

Wskaźnik eGFR stanowi jedno z podstawowych badań pozwalających na ocenę czynności nerek. Ma ono szczególną wartość w przewlekłej chorobie nerek. 

```{r eGFRPlot, results='markup'}
maxNo = (attributes_time_change %>% filter(colName == 'eGFR') %>% group_by(survived) %>% summarize(maxNo = max(no, na.rm = TRUE)) %>% arrange(maxNo))[1,2]
  
eGFR <- attributes_time_change %>% filter(colName == 'eGFR') %>% filter(no <= (as.numeric(maxNo[1]) - 1)) %>% group_by(no, survived) %>% summarize(mean_val = mean(value), colName = first(colName)) %>% rename(przeżył = survived)

eGFRPlot <- ggplot(eGFR, aes(x=no, y=mean_val, color=przeżył)) + geom_line() + labs(x='nr próbki', y='śr. eGFR [ml/min/1.73m^2]') + theme_light()

ggplotly(eGFRPlot)
```

Wykres ukazuje średnio wyższą wartość wskaźnika eGFR dla osób, którym udało się przeżyć zakażenie wirusem. U osób, które nie przeżyły zachorowania na COVID-19, wskaźnik eGFR jest niższy i ma tendencję spadkową.

### hs-CRP

Podstawowym zastosowaniem klinicznym badania hs-CRP (wysoko czułe białko C-reaktywne) jest ocena ryzyka chorób sercowo-naczyniowych.

```{r hsCRPPlot, results='markup'}
maxNo = (attributes_time_change %>% filter(colName == 'High.sensitivity.C.reactive.protein') %>% group_by(survived) %>% summarize(maxNo = max(no, na.rm = TRUE)) %>% arrange(maxNo))[1,2]
  
hsCRP <- attributes_time_change %>% filter(colName == 'High.sensitivity.C.reactive.protein') %>% filter(no <= (as.numeric(maxNo[1]) - 1)) %>% group_by(no, survived) %>% summarize(mean_val = mean(value), colName = first(colName)) %>% rename(przeżył = survived)

hsCRPPlot <- ggplot(hsCRP, aes(x=no, y=mean_val, color=przeżył)) + geom_line() + labs(x='nr próbki', y='średnie hs-CRP [mg/l]') + theme_light()

ggplotly(hsCRPPlot)
```

Wykres prezentuje średnio wyższy wskaźnik hs-CRP dla osób, które nie przeżyły zakażenia wirusem SARS-CoV-2.

## Klasyfikator

---
todo
---